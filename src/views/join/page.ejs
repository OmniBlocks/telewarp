<div class="hero">
    <h1>Create Account</h1>
</div>

<div class="page">
    <p id="hidethisonload">Loading... Make sure to enable JavaScript if you haven't already.</p>

    <div id="authform" style="display:none">
        <form id="registerForm" class="upload-form">
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required minlength="3" placeholder="At least 3 characters">
            </div>

            <div class="input-group" style="margin-top: 1rem;">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required minlength="8" placeholder="At least 8 characters">
            </div>
<p>By registering you agree that Telewarp is going to break permanently tomorrow.</p>

            <div id="projectInfo" style="display: block; margin-top: 2rem;">
                <button type="submit">Register</button>
                <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.7;">
                    Already have an account? <a href="/login" style="color: var(--accent);">Sign in</a>
                </p>
            </div>
        </form>
    </div>
</div>

<div id="errorPopup">
    <div id="errorPopupMessage" style="margin-top:0.5rem"></div>
</div>

<script>
    // Show form immediately
    document.getElementById("authform").style.display = "block";
    document.getElementById("hidethisonload").style.display = "none";

    const form = document.getElementById("registerForm");
    const errorPopup = document.getElementById("errorPopup");
    const errorPopupMessage = document.getElementById("errorPopupMessage");

    function showError(message) {
        errorPopupMessage.textContent = message;
        errorPopup.style.display = "block";
        setTimeout(() => errorPopup.style.display = "none", 6000);
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
            // Pointing to your unified API with action=signup
            const res = await fetch("/api/user-api?action=signup", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || "Could not register");
            }

            // Success! Redirect to login or home
            window.location.href = "/";

        } catch (err) {
            console.error(err);
            showError(err.message);
        }
    });
</script>
