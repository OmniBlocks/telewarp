<div class="hero">
  <h1>
    <%= project ? project.name : "Error" %>
  </h1>
</div>

<div class="page">
  <% if (error) { %>
    <p>Failed to get project information. This has been automatically logged.</p>
  <% } else { %>

    <!-- Controls above project -->
    <div id="projectControls" style="margin-bottom: 10px;">
      <button id="greenFlagBtn">üü¢ Green Flag</button>
      <button id="stopBtn">‚èπ Stop</button>
      <button id="fullscreenBtn">‚õ∂ Fullscreen</button>
    </div>

    <div id="projectWrapper" style="position:relative; width:480px; height:360px;">
      <div id="project" style="width:100%; height:100%;"></div>

      <!-- Loading overlay -->
      <div id="loadingOverlay" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: black;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 10000;
      ">
        <h2 style="color:white; margin-bottom:10px;" id="progressText">Loading project</h2>
        <div id="progressContainer" style="
          width: 80%;
          height: 8px;
          border: 1px white solid;
          overflow: hidden;
        ">
          <div id="progressBar" style="
            width: 0%;
            height: 100%;
            background-color: white;
            transition: width 0.2s ease;
          "></div>
        </div>
      </div>

      <!-- Green flag overlay -->
      <div id="greenFlagOverlay" style="
        position: absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:9000;
        cursor:pointer;
        background: #00000055;
      ">
        <img src="/images/flag.svg" alt="Green Flag" style="width:64px; height:64px;">
      </div>

      <!-- Custom Security Manager Modal -->
      <div id="securityModal" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: black;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 11000;
        flex-direction: column;
        color: white;
        padding: 20px;
        box-sizing: border-box;
        line-height: 1;
        font-size: 0.85em;
        text-align: center;
      ">
        <h1 style="margin:0">Untrusted extension</h1>
        <p style="margin:0">This extension will run without the sandbox, meaning it can access anything in the page. Review the code before continuing.</p>
        <pre id="extensionCode" style="
          padding: 4px;
          border-radius: 4px;
          color: white;
          width: 95%;
          overflow: auto; 
          font-size: 0.7em;
          text-align: left;
          margin-top:8px;
        ">Loading code...</pre>
        <div style="margin-top:8px;">
          <button id="allowExtensionBtn">Continue</button>
        </div>
      </div>

    </div>

    <% 
      const platform = platforms.find(p => p.id === project.lang_id);
      if (platform) { 
        const editLink = platform.edit.replace("{url}", '');
    %>
      <a href="<%= editLink %>" target="_blank" id="editLink">Edit</a>
    <% } else { %>
      Unknown
    <% } %>
  </p>

    <p><strong>Platform:</strong> 
      <% if (platform) { %>
        <a href="<%= platform.url %>" target="_blank"><%= platform.name %></a>
      <% } else { %>
        Unknown
      <% } %>
    </p>
    <% if (project.description) { %>
      <p><%= project.description %></p>
    <% } %>
  <% } %>
</div>

<% if (!error) { %>
<script src="/scaffolding.js" defer></script>
<script>
const editLink = document.getElementById("editLink");
if (editLink) {
  editLink.href += window.location.origin + `/api/sb3?id=<%= project.id %>`;
}

document.addEventListener("DOMContentLoaded", async () => {
  if (typeof Scaffolding === "undefined") {
    console.error("Scaffolding library not loaded yet!");
    return;
  }

  const scaffolding = new Scaffolding.Scaffolding();
  scaffolding.usePackagedRuntime = true;
  scaffolding.setup();
  scaffolding.appendTo(document.getElementById('project'));
  window.vm = scaffolding.vm;

  const loadingOverlay = document.getElementById("loadingOverlay");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const greenFlagOverlay = document.getElementById("greenFlagOverlay");
  const securityModal = document.getElementById("securityModal");
  const extensionCodeEl = document.getElementById("extensionCode");
  const apiRoot = window.location.origin;

  const storage = scaffolding.storage;
  storage.addWebStore(
    [storage.AssetType.ImageVector, storage.AssetType.ImageBitmap, storage.AssetType.Sound],
    (asset) => `${apiRoot}/api/asset?id=${asset.assetId}.${asset.dataFormat}`
  );

  // Asset progress
  vm.on('ASSET_PROGRESS', (finished, total) => {
    progressText.textContent = `Downloading assets (${finished}/${total})`;
    const percent = total > 0 ? (finished / total) * 100 : 0;
    progressBar.style.width = `${percent}%`;
  });

  // ---------------- Custom Security Manager ----------------
  scaffolding.setExtensionSecurityManager({
    getSandboxMode: (url) => 'unsandboxed',
    canLoadExtensionFromProject: async (url) => {
      if (url.startsWith("https://extensions.turbowarp.org/")) return true;

      securityModal.style.display = "flex";
      extensionCodeEl.textContent = "Loading code...";

      try {
        const res = await fetch(url);
        extensionCodeEl.textContent = await res.text();
      } catch (e) {
        extensionCodeEl.textContent = `Failed to fetch extension code: ${e}`;
      }

      return new Promise((resolve) => {
        const allowBtn = document.getElementById("allowExtensionBtn");

        function cleanup() {
          allowBtn.removeEventListener("click", onAllow);
          securityModal.style.display = "none";
        }

        function onAllow() { cleanup(); resolve(true); }

        allowBtn.addEventListener("click", onAllow);
      });
    }
  });

  // ---------------- Load project ----------------
  try {
    const projectId = "<%= project.id %>";
    const res = await fetch(`${apiRoot}/api/project?id=${projectId}`);
    const projectData = await res.json();
    await scaffolding.loadProject(projectData);

    loadingOverlay.style.display = "none";
    greenFlagOverlay.style.display = "flex";
  } catch (e) {
    console.error("Failed to load project:", e);
    progressText.textContent = "Failed to load project";
  }

  // ---------------- Green flag logic ----------------
  function triggerGreenFlag() {
    scaffolding.greenFlag();
    greenFlagOverlay.style.display = "none";
  }

  greenFlagOverlay.addEventListener("click", triggerGreenFlag);
  document.getElementById("greenFlagBtn").addEventListener("click", triggerGreenFlag);

  // ---------------- Stop and Fullscreen ----------------
  document.getElementById("stopBtn").addEventListener("click", () => scaffolding.stopAll());
  document.getElementById("fullscreenBtn").addEventListener("click", () => {
    const wrapper = document.getElementById("projectWrapper");
    if (!document.fullscreenElement) wrapper.requestFullscreen();
    else document.exitFullscreen();
  });

});
</script>
<% } %>
