<div class="hero">
    <h1>Sign In</h1>
</div>

<div class="page">
    <p id="hidethisonload">Loading... Make sure to enable JavaScript if you haven't already.</p>

    <div id="authform" style="display:none">
        <form id="loginForm" class="upload-form">
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
            </div>

            <div class="input-group" style="margin-top: 1rem;">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>

            <div id="projectInfo" style="display: block; margin-top: 2rem;">
                <button type="submit">Login</button>
                <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.7;">
                    Don't have an account? <a href="/join" style="color: var(--accent);">Join!</a>
                </p>
            </div>
        </form>
    </div>
</div>

<div id="errorPopup">
    <div id="errorPopupMessage" style="margin-top:0.5rem"></div>
</div>

<script>
    // Show form immediately
    document.getElementById("authform").style.display = "block";
    document.getElementById("hidethisonload").style.display = "none";

    const form = document.getElementById("loginForm");
    const errorPopup = document.getElementById("errorPopup");
    const errorPopupMessage = document.getElementById("errorPopupMessage");

    function showError(message) {
        errorPopupMessage.textContent = message;
        errorPopup.style.display = "block";
        setTimeout(() => errorPopup.style.display = "none", 6000);
    }

    // Check if we just redirected from a successful registration
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('registered')) {
        // Optional: show a "Registration successful! Please login" toast here
        console.log("Registered successfully");
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
            // Note the change to action=signin
            const res = await fetch("/api/user-api?action=signin", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();

            if (!res.ok) {
                // This will catch "User not found" or "Incorrect password"
                throw new Error(data.error || "Login failed");
            }

            // Success! The server has already sent the Set-Cookie header.
            // Redirecting to home will now trigger the middleware to recognize the user.
            window.location.href = "/";

        } catch (err) {
            console.error(err);
            showError(err.message);
        }
    });
</script>