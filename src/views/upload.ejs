<style>
/* ===== Drag & drop area ===== */
.file-drop-zone {
    position: relative;
    border: 2px dashed #bbb;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1rem;
    transition: border-color 0.3s, background-color 0.3s;
    cursor: pointer;
    background-color: var(--background);
}

.file-drop-zone.dragover {
    border-color: #007bff;
}

.file-drop-text {
    color: #666;
    font-style: italic;
    pointer-events: none;
}

.file-input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
}

#projectPlatform {
    font-weight: bold;
    color: #007bff;
}

button[type="submit"], #regenerateThumbnailBtn {
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    margin-top: 0.5rem;
}

button[type="submit"]:hover, #regenerateThumbnailBtn:hover {
    background-color: #0056b3;
}

#errorPopup {
    position: fixed;
    top: 20px;
    right: 20px;
    max-width: 320px;
    background: #ffefef;
    border: 1px solid #e57373;
    color: #7a1c1c;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: none;
    z-index: 1000;
}

/* ===== Thumbnail preview ===== */
#thumbnailPreview {
    max-width: 100%;
    max-height: 200px;
    display: none;
    margin-top: 8px;
    border: 1px solid var(--solid-border);
    border-radius: 4px;
}
</style>

<div class="hero">
    <h1>Upload project</h1>
</div>

<div class="page">
    <p id="hidethisonload">Loading... Make sure to enable JavaScript if you haven't already.</p>

    <div id="uploadform" style="display:none">
        <form action="/api/upload" method="post" enctype="multipart/form-data" class="upload-form">
            <input type="text" name="langId" hidden readonly id="langId">

            <div class="file-drop-zone">
                <input type="file" name="projectFile" class="file-input">
                <p class="file-drop-text">Drag & drop a file here or click to select</p>
            </div>

            <details>
                <summary>Supported programming languages</summary>
                <ul>
                    <% platforms.forEach(function(p) { %>
                        <% p.accept.forEach(function(ext) { %>
                            <li><%= p.name %> (<%= ext %>)</li>
                        <% }) %>
                    <% }) %>
                </ul>
            </details>

            <div id="projectInfo" style="display: none">
            <h1>Add information</h1>

            <label for="projectName">Project Name:</label>
            <input type="text" id="projectName" name="projectName" required>
            <br>

            <label>Project Platform:</label>
            <span id="projectPlatform"></span>
            <br>

            <label for="projectDescription">Project Notes:</label>
            <textarea id="projectDescription" name="projectDescription" rows="4"></textarea>
            <br>
            <h2>Thumbnail</h2>
            <p>Tip: To change the thumbnail, create a new sprite that hides when the green flag is clicked. Before saving, show that sprite.</p>
            <div id="sc" style="top: 0; left: 0; position: fixed; width: 480px; aspect-ratio: 4/3; overflow: visible; opacity: 0; pointer-events: none;"></div>
            <img id="thumbnailPreview" alt="Project thumbnail">
            <p>If something's missing, click "Regenerate Thumbnail". Note that thumbnails for projects with untrusted extensions are not generated for security reasons.</p>
            <button type="button" id="regenerateThumbnailBtn">Regenerate Thumbnail</button>
            <br><button type="submit">Upload</button></div>
        </form>
    </div>
</div>

<div id="errorPopup">
    <strong>Upload failed</strong>
    <div id="errorPopupMessage" style="margin-top:0.5rem"></div>
</div>

<!-- use ob for omniblocks compat -->
<script src="/scaffolding-ob.js" defer></script>
<script>
document.getElementById("uploadform").style.display = "block";
document.getElementById("hidethisonload").style.display = "none";

const form = document.querySelector(".upload-form");
const fileInput = document.querySelector(".file-input");
const langIdInput = document.getElementById("langId");
const projectNameInput = document.getElementById("projectName");
const projectPlatformSpan = document.getElementById("projectPlatform");
const fileDropZone = document.querySelector(".file-drop-zone");
const thumbnailPreview = document.getElementById("thumbnailPreview");
const regenerateBtn = document.getElementById("regenerateThumbnailBtn");

const errorPopup = document.getElementById("errorPopup");
const errorPopupMessage = document.getElementById("errorPopupMessage");

let scaffolding = null;
let capturedThumbnail = null;

// -------- error popup --------
function showError(message) {
    errorPopupMessage.textContent = message;
    errorPopup.style.display = "block";
    setTimeout(() => errorPopup.style.display = "none", 6000);
}

// -------- extension map --------
const extensionMap = {
    <% platforms.forEach(function(p) { %>
        <% p.accept.forEach(function(ext) { %>
            "<%= ext.replace('.', '') %>": { id: "<%= p.id %>", name: "<%= p.name %>" },
        <% }) %>
    <% }) %>
};

fileInput.setAttribute(
    "accept",
    Object.keys(extensionMap).map(e => "." + e).join(", ")
);

// -------- Scaffolding setup ----------
document.addEventListener("DOMContentLoaded", async () => {
    if (typeof Scaffolding === "undefined") {
        console.error("Scaffolding library not loaded yet!");
        return;
    }

    scaffolding = new Scaffolding.Scaffolding();
    scaffolding.usePackagedRuntime = true;
    scaffolding.connectPeripherals = false;
    scaffolding.resizeMode = 'dynamic-resize';
    scaffolding.setup();
    scaffolding.appendTo(document.querySelector('#sc'));

    scaffolding.setExtensionSecurityManager({
        getSandboxMode: () => 'unsandboxed',
        canLoadExtensionFromProject: url => url.startsWith("https://extensions.turbowarp.org/") || url.startsWith("https://omniblocks.github.io/extensions/"),
    });
});

// -------- file handling with project load ----------
async function handleFile(file) {
    document.getElementById("projectInfo").style.display = "block";
    const name = file.name.replace(/\.[^/.]+$/, "");
    const ext = file.name.split(".").pop().toLowerCase();

    projectNameInput.value = name;

    const info = extensionMap[ext];
    if (info) {
        langIdInput.value = info.id;
        projectPlatformSpan.textContent = info.name;
    } else {
        langIdInput.value = "";
        projectPlatformSpan.textContent = "Unknown";
    }

    if (!scaffolding) return showError("Scaffolding not initialized.");

    try {
        const arrayBuffer = await file.arrayBuffer();
        await scaffolding.loadProject(arrayBuffer);

        // Capture thumbnail immediately
        await captureThumbnail();
    } catch (err) {
        console.error(err);
        showError("Failed to load project: " + err.message);
    }
}

// -------- drag & drop --------
fileDropZone.addEventListener("dragover", e => {
    e.preventDefault();
    fileDropZone.classList.add("dragover");
});

fileDropZone.addEventListener("dragleave", () => {
    fileDropZone.classList.remove("dragover");
});

fileDropZone.addEventListener("drop", e => {
    e.preventDefault();
    fileDropZone.classList.remove("dragover");

    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFile(e.dataTransfer.files[0]);
    }
});

fileInput.addEventListener("change", () => {
    if (fileInput.files.length) handleFile(fileInput.files[0]);
});

// -------- thumbnail capture ----------
async function captureThumbnail() {
    let canvas = document.querySelector(".sc-canvas");
    const start = Date.now();
    while (!canvas && Date.now() - start < 3000) {
        await new Promise(r => setTimeout(r, 50));
        canvas = document.querySelector(".sc-canvas");
    }

    if (!canvas) {
        showError("Failed to capture thumbnail: canvas not found");
        return null;
    }

    scaffolding.relayout();

    const dataUrl = canvas.toDataURL("image/png");
    capturedThumbnail = dataUrl;

    thumbnailPreview.src = dataUrl;
    thumbnailPreview.style.display = "block";

    return dataUrl;
}

// -------- regenerate button --------
regenerateBtn.addEventListener("click", async () => {
    if (!fileInput.files.length) return showError("No project loaded to capture thumbnail.");
    await captureThumbnail();
});

// -------- AJAX submit --------
form.addEventListener("submit", async e => {
    e.preventDefault();

    if (!fileInput.files.length) {
        showError("Please select a file to upload.");
        return;
    }

    const formData = new FormData(form);

    if (capturedThumbnail) {
        const blob = await (await fetch(capturedThumbnail)).blob();
        formData.append("thumbnail", blob, "thumbnail.png");
    }

    try {
        const res = await fetch(form.action, {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
            throw new Error(data.error || "Upload failed");
        }

        window.location.href = `/projects/${data.id}`;

    } catch (err) {
        console.error(err);
        showError(err.message || "Unexpected upload error");
    }
});
</script>
